import random
from dataclasses import dataclass
from datetime import datetime, timedelta
from enum import Enum
from typing import Dict, List, Optional, Union

from bot.database.models.investigation import Investigation, InvestigationStage
from game.player.skills import SkillType
from game.player.energy import ActionType

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ç–∏–ø–æ–≤ —É–ª–∏–∫
EVIDENCE_PHOTOS = "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"
EVIDENCE_DOCUMENTS = "–¥–æ–∫—É–º–µ–Ω—Ç—ã"


class CrimeType(Enum):
    """–¢–∏–ø—ã –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–π"""

    MURDER = "murder"
    KIDNAPPING = "kidnapping"
    ROBBERY = "robbery"
    FRAUD = "fraud"
    BLACKMAIL = "blackmail"
    ARSON = "arson"
    THEFT = "theft"
    ASSAULT = "assault"


class Difficulty(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"""

    EASY = 1
    MEDIUM = 2
    HARD = 3
    EXPERT = 4


@dataclass
class Location:
    """–®–∞–±–ª–æ–Ω –ª–æ–∫–∞—Ü–∏–∏"""

    name: str
    description: str
    available_actions: List[str]
    clues: List[str]
    suspects: List[str]


@dataclass
class Evidence:
    """–®–∞–±–ª–æ–Ω —É–ª–∏–∫–∏"""

    name: str
    description: str
    type: str
    importance: int  # 1-5
    analysis_time: int  # –≤ –º–∏–Ω—É—Ç–∞—Ö
    possible_conclusions: List[str]
    required_skills: List[str]


@dataclass
class Suspect:
    """–®–∞–±–ª–æ–Ω –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ"""

    name: str
    description: str
    alibi: str
    motives: List[str]
    evidence: List[str]
    is_guilty: bool


@dataclass
class CaseTemplate:
    """–®–∞–±–ª–æ–Ω —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"""

    id: str
    title: str
    description: str
    difficulty: Difficulty
    locations: List[Location]
    suspects: List[Suspect]
    key_evidence: List[str]
    red_herrings: List[str]
    correct_sequence: List[str]
    hints: Dict[int, List[str]]  # –£—Ä–æ–≤–µ–Ω—å –Ω–∞–≤—ã–∫–∞ -> —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫


# –®–∞–±–ª–æ–Ω—ã –ª–æ–∫–∞—Ü–∏–π
LOCATION_TEMPLATES = {
    "crime_scene": Location(
        name="–ú–µ—Å—Ç–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è",
        description="–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ",
        available_actions=["–û—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Å—Ç–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è", "–û–ø—Ä–æ—Å–∏—Ç—å —Å–≤–∏–¥–µ—Ç–µ–ª–µ–π"],
        clues=[
            "–æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–∞–ª—å—Ü–µ–≤",
            "—Å–ª–µ–¥—ã –∫—Ä–æ–≤–∏",
            "—Å–ª–æ–º–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
            "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –≤–µ—â–∏",
            "–∑–∞–ø–∏—Å–∫–∏",
            EVIDENCE_PHOTOS,
        ],
        suspects=["—Å–≤–∏–¥–µ—Ç–µ–ª–∏", "–ø–µ—Ä–≤—ã–π –Ω–∞—à–µ–¥—à–∏–π", "–æ—á–µ–≤–∏–¥—Ü—ã", "—Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ—Ö–æ–∂–∏–µ"],
    ),
    "police_station": Location(
        name="–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π —É—á–∞—Å—Ç–æ–∫",
        description="–ú–µ—Å—Ç–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∏ –¥–æ–ø—Ä–æ—Å–æ–≤",
        available_actions=[
            "–û—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã",
            "–û–ø—Ä–æ—Å–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã—Ö",
            "–û–ø—Ä–æ—Å–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–æ—Ä–æ–≤",
        ],
        clues=["–ø—Ä–æ—Ç–æ–∫–æ–ª—ã", EVIDENCE_PHOTOS, "–∑–∞–ø–∏—Å–∏ –¥–æ–ø—Ä–æ—Å–æ–≤", "–¥–æ—Å—å–µ", "–æ—Ç—á–µ—Ç—ã"],
        suspects=["–∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ", "—Å–≤–∏–¥–µ—Ç–µ–ª–∏", "–∏–Ω—Ñ–æ—Ä–º–∞—Ç–æ—Ä—ã", "–∫–æ–ª–ª–µ–≥–∏"],
    ),
}

# –®–∞–±–ª–æ–Ω—ã —É–ª–∏–∫
EVIDENCE_TEMPLATES = {
    "physical": Evidence(
        name="–§–∏–∑–∏—á–µ—Å–∫–∞—è —É–ª–∏–∫–∞",
        description="–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º",
        type="physical",
        importance=3,
        analysis_time=30,
        possible_conclusions=[
            "–ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–º—É",
            "—Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—ã –î–ù–ö",
            "–∏–º–µ–µ—Ç –æ—Ç–ø–µ—á–∞—Ç–∫–∏",
            "–±—ã–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω",
            "–±—ã–ª –ø–µ—Ä–µ–º–µ—â–µ–Ω",
        ],
        required_skills=["forensic", "detective"],
    ),
    "documentary": Evidence(
        name="–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —É–ª–∏–∫–∞",
        description="–ë—É–º–∞–≥–∏, –∑–∞–ø–∏—Å–∏, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
        type="documentary",
        importance=2,
        analysis_time=20,
        possible_conclusions=[
            "–ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å",
            "–≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è",
            "–∞–≤—Ç–æ—Ä—Å—Ç–≤–æ",
            "—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ",
            "–∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π",
        ],
        required_skills=["detective", "forensic"],
    ),
    "testimonial": Evidence(
        name="–ü–æ–∫–∞–∑–∞–Ω–∏—è",
        description="–£—Å—Ç–Ω—ã–µ –∏–ª–∏ –ø–∏—Å—å–º–µ–Ω–Ω—ã–µ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞",
        type="testimonial",
        importance=2,
        analysis_time=15,
        possible_conclusions=[
            "–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å",
            "–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è",
            "–º–æ—Ç–∏–≤—ã",
            "–æ—Ç–Ω–æ—à–µ–Ω–∏—è",
            "–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è",
        ],
        required_skills=["psychology", "detective"],
    ),
}

# –®–∞–±–ª–æ–Ω—ã –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö
SUSPECT_TEMPLATES = {
    "primary": Suspect(
        name="–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π",
        description="–ì–ª–∞–≤–Ω—ã–π –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π –≤ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏",
        alibi="–±—ã–ª –¥–æ–º–∞",
        motives=["–º–µ—Å—Ç—å", "–¥–µ–Ω—å–≥–∏", "–≤–ª–∞—Å—Ç—å", "–ª—é–±–æ–≤—å", "–∑–∞–≤–∏—Å—Ç—å", "—Å–∞–º–æ–∑–∞—â–∏—Ç–∞"],
        evidence=["–æ—Ç–ø–µ—á–∞—Ç–∫–∏", "–î–ù–ö", EVIDENCE_DOCUMENTS, EVIDENCE_PHOTOS, "–∑–∞–ø–∏—Å–∏"],
        is_guilty=False,
    )
}

# –®–∞–±–ª–æ–Ω—ã —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
CASE_TEMPLATES = {
    "murder_basic": CaseTemplate(
        id="murder_001",
        title="–£–±–∏–π—Å—Ç–≤–æ –≤ —Å—Ç–∞—Ä–æ–º –æ—Å–æ–±–Ω—è–∫–µ",
        description=(
            "–í —Ä–æ—Å–∫–æ—à–Ω–æ–º –æ—Å–æ–±–Ω—è–∫–µ –Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ –≥–æ—Ä–æ–¥–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ç–µ–ª–æ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–∞ "
            "–∞–Ω—Ç–∏–∫–≤–∞—Ä–∏–∞—Ç–∞. –°–º–µ—Ä—Ç—å –Ω–∞—Å—Ç—É–ø–∏–ª–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è. –í –¥–æ–º–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ "
            "–±–ª–∏–∑–∫–∏–µ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏ –∏ —Å–ª—É–≥–∏. –ö—Ç–æ –∂–µ —Å–æ–≤–µ—Ä—à–∏–ª —ç—Ç–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ?"
        ),
        difficulty=Difficulty.MEDIUM,
        locations=[
            LOCATION_TEMPLATES["crime_scene"],
            LOCATION_TEMPLATES["police_station"],
        ],
        suspects=[SUSPECT_TEMPLATES["primary"]],
        key_evidence=[
            "–û—Å—Ç–∞—Ç–∫–∏ —è–¥–∞ –≤ –±–æ–∫–∞–ª–µ –≤–∏–Ω–∞",
            "–°–ª–µ–¥—ã –≥—Ä—è–∑–∏ –æ—Ç —Å–∞–¥–æ–≤—ã—Ö –±–æ—Ç–∏–Ω–æ–∫",
            "–ó–∞–ø–∏—Å–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á–∞—Ö",
            "–°—Ç—Ä–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ –ø–ª–µ–º—è–Ω–Ω–∏–∫–∞",
            "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ –≤ –Ω–æ—á—å —É–±–∏–π—Å—Ç–≤–∞",
        ],
        red_herrings=[
            "–°–ª–æ–º–∞–Ω–Ω–∞—è —Ä—É—á–∫–∞ —á–∞–π–Ω–∏–∫–∞",
            "–°—Ç—Ä–∞–Ω–Ω—ã–µ –ø—è—Ç–Ω–∞ –Ω–∞ —Ñ–∞—Ä—Ç—É–∫–µ –≥–æ—Ä–Ω–∏—á–Ω–æ–π",
            "–û—Ç–∫—Ä—ã—Ç—ã–π —Å–µ–π—Ñ",
            "–°–ª–µ–¥—ã —Å–∞–∂–∏ –Ω–∞ —Ä—É–∫–∞—Ö –¥–≤–æ—Ä–µ—Ü–∫–æ–≥–æ",
            "–ü—É—Å—Ç–∞—è –±—É—Ç—ã–ª–∫–∞ –∏–∑-–ø–æ–¥ –≤–∏–Ω–∞",
        ],
        correct_sequence=[
            "–û—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Å—Ç–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è",
            "–°–æ–±—Ä–∞—Ç—å —É–ª–∏–∫–∏",
            "–û–ø—Ä–æ—Å–∏—Ç—å —Å–≤–∏–¥–µ—Ç–µ–ª–µ–π",
            "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ª–∏–±–∏",
            "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ—Ç–∏–≤—ã",
            "–°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞",
            "–í—ã—è–≤–∏—Ç—å –≤–∏–Ω–æ–≤–Ω–æ–≥–æ",
        ],
        hints={
            1: [
                "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—ã –Ω–∞ –ø–æ–ª—É",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–æ–∫–∞–ª–æ–≤",
                "–†–∞—Å—Å–ø—Ä–æ—Å–∏—Ç–µ –≤—Å–µ—Ö —Å–≤–∏–¥–µ—Ç–µ–ª–µ–π",
            ],
            2: [
                "–°—Ä–∞–≤–Ω–∏—Ç–µ –∞–ª–∏–±–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
                "–ò–∑—É—á–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
            ],
            3: [
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –º–æ—Ç–∏–≤—ã –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ",
                "–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —É–ª–∏–∫–∏ —Å –∞–ª–∏–±–∏",
                "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è",
            ],
            4: [
                "–ò–∑—É—á–∏—Ç–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º–∏",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏",
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –Ω–æ—á—å —É–±–∏–π—Å—Ç–≤–∞",
            ],
        },
    )
}

# –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è Claude API
CLAUDE_PROMPTS = {
    "generate_story": """
    –°–æ–∑–¥–∞–π –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
    - –¢–∏–ø –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è: {crime_type}
    - –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty}
    - –õ–æ–∫–∞—Ü–∏—è: {location}
    - –ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ: {suspects}
    
    –ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å:
    1. –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è
    2. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö
    3. –ù–∞–π–¥–µ–Ω–Ω—ã–µ —É–ª–∏–∫–∏
    4. –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—é–∂–µ—Ç–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã
    5. –ö–ª—é—á–µ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    """,
    "analyze_evidence": """
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é —É–ª–∏–∫—É:
    - –¢–∏–ø: {evidence_type}
    - –û–ø–∏—Å–∞–Ω–∏–µ: {evidence_description}
    - –ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}
    
    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
    1. –í–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã
    2. –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞–≤—ã–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    3. –í—Ä–µ–º—è –Ω–∞ –∞–Ω–∞–ª–∏–∑
    4. –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —É–ª–∏–∫–∞–º–∏
    """,
    "create_profile": """
    –°–æ–∑–¥–∞–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ:
    - –ò–º—è: {name}
    - –û–ø–∏—Å–∞–Ω–∏–µ: {description}
    - –ú–æ—Ç–∏–≤—ã: {motives}
    - –ê–ª–∏–±–∏: {alibi}
    
    –í–∫–ª—é—á–∏:
    1. –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —á–µ—Ä—Ç—ã
    2. –í–æ–∑–º–æ–∂–Ω—ã–µ –º–æ—Ç–∏–≤—ã
    3. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏—á–∞—Å—Ç–Ω–æ—Å—Ç–∏
    4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ–ø—Ä–æ—Å—É
    """,
}

# –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
MESSAGE_TEMPLATES = {
    "case_start": """
    üïµÔ∏è –ù–æ–≤–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: {title}
    
    {description}
    
    ‚è∞ –í—Ä–µ–º—è –Ω–∞ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: {time_limit} —á–∞—Å–æ–≤
    üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty}
    
    –ù–∞—á–Ω–∏—Ç–µ —Å –æ—Å–º–æ—Ç—Ä–∞ –º–µ—Å—Ç–∞ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è.
    """,
    "evidence_found": """
    üîç –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —É–ª–∏–∫–∞!
    
    {evidence_description}
    
    –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?
    1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É–ª–∏–∫—É
    2. –°–≤—è–∑–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —É–ª–∏–∫–∞–º–∏
    3. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–º
    """,
    "suspect_interview": """
    üë§ –î–æ–ø—Ä–æ—Å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ: {suspect_name}
    
    {suspect_description}
    
    –ê–ª–∏–±–∏: {alibi}
    
    –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–∫—Ç–∏–∫—É –¥–æ–ø—Ä–æ—Å–∞.
    """,
    "case_success": """
    üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –î–µ–ª–æ —Ä–∞—Å–∫—Ä—ã—Ç–æ!
    
    –ü—Ä–µ—Å—Ç—É–ø–Ω–∏–∫: {culprit}
    –ú–æ—Ç–∏–≤: {motive}
    
    –í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
    {achievements}
    
    –ù–∞–≥—Ä–∞–¥–∞: {reward}
    """,
    "case_failure": """
    ‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ...
    
    –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:
    {failure_reasons}
    
    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –¥–µ–ª–æ.
    """,
}

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–æ—Ç–∏–≤–æ–≤ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
CHARACTER_TRAITS = {
    "motives": [
        "–º–µ—Å—Ç—å",
        "–¥–µ–Ω—å–≥–∏",
        "–≤–ª–∞—Å—Ç—å",
        "–ª—é–±–æ–≤—å",
        "–∑–∞–≤–∏—Å—Ç—å",
        "—Å–∞–º–æ–∑–∞—â–∏—Ç–∞",
        "–∏–¥–µ–æ–ª–æ–≥–∏—è",
        "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
        "—Å–µ–º–µ–π–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞",
        "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã",
    ],
    "personality_traits": [
        "–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π",
        "—Ö–∏—Ç—Ä—ã–π",
        "—É–º–Ω—ã–π",
        "—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π",
        "—Ö–æ–ª–æ–¥–Ω—ã–π",
        "–∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–π",
        "—Ä–∞—Å—á–µ—Ç–ª–∏–≤—ã–π",
        "—Ç—Ä—É—Å–ª–∏–≤—ã–π",
        "—Ö—Ä–∞–±—Ä—ã–π",
        "–º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–π",
    ],
    "occupations": [
        "–±–∏–∑–Ω–µ—Å–º–µ–Ω",
        "–ø–æ–ª–∏—Ç–∏–∫",
        "–≤—Ä–∞—á",
        "—é—Ä–∏—Å—Ç",
        "–ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–π",
        "–ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫",
        "—Å–ª—É–∂–∞—â–∏–π",
        "–∞—Ä—Ç–∏—Å—Ç",
        "—É—á–µ–Ω—ã–π",
        "–≤–æ–µ–Ω–Ω—ã–π",
    ],
}

# –°–∏—Å—Ç–µ–º–∞ –≤–µ—Ç–≤–ª–µ–Ω–∏—è —Å—é–∂–µ—Ç–∞
PLOT_BRANCHES = {
    "evidence_analysis": {
        "success": {
            "next_steps": [
                "–Ω–∞–π—Ç–∏ –Ω–æ–≤—ã–µ —É–ª–∏–∫–∏",
                "–¥–æ–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
                "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–ª–∏–±–∏",
                "—Å–≤—è–∑–∞—Ç—å —É–ª–∏–∫–∏",
            ],
            "consequences": [
                "–Ω–æ–≤—ã–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ",
                "–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤",
                "—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –ª–æ–∫–∞—Ü–∏–π",
                "–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫",
            ],
        },
        "failure": {
            "next_steps": [
                "–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑",
                "–∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏–µ —É–ª–∏–∫–∏",
                "–∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥—Ö–æ–¥",
                "–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏",
            ],
            "consequences": [
                "–ø–æ—Ç–µ—Ä—è –≤—Ä–µ–º–µ–Ω–∏",
                "—É—Ö—É–¥—à–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
                "–ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
                "–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
            ],
        },
    },
    "suspect_interview": {
        "success": {
            "next_steps": [
                "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è",
                "–∏—Å–∫–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
                "–¥–æ–ø—Ä–æ—Å–∏—Ç—å –¥—Ä—É–≥–∏—Ö",
                "–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑–∏",
            ],
            "consequences": [
                "–Ω–æ–≤—ã–µ —É–ª–∏–∫–∏",
                "–∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
                "—Ä–∞–∑–æ–±–ª–∞—á–µ–Ω–∏–µ –ª–∂–∏",
                "–ø–æ–ª—É—á–µ–Ω–∏–µ –∞–ª–∏–±–∏",
            ],
        },
        "failure": {
            "next_steps": [
                "–∏–∑–º–µ–Ω–∏—Ç—å —Ç–∞–∫—Ç–∏–∫—É",
                "–¥–æ–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞",
                "–∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–¥—Ö–æ–¥—ã",
                "–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º",
            ],
            "consequences": [
                "—É—Ö—É–¥—à–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
                "–ø–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è",
                "–∑–∞–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞",
                "–ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
            ],
        },
    },
}

# –®–∞–±–ª–æ–Ω—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω
FINAL_SCENES = {
    "success": {
        "title": "–¢—Ä–∏—É–º—Ñ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ",
        "description": """
        –ü–æ—Å–ª–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤—Å–µ —É–ª–∏–∫–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ {culprit}.
        –ú–æ—Ç–∏–≤: {motive}
        –ú–µ—Ç–æ–¥: {method}
        
        {resolution}
        
        –î–µ–ª–æ –∑–∞–∫—Ä—ã—Ç–æ —É—Å–ø–µ—à–Ω–æ!
        """,
        "rewards": {
            "experience": 100,
            "reputation": 50,
            "money": 1000,
            "items": ["–º–µ–¥–∞–ª—å", "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", EVIDENCE_DOCUMENTS],
        },
    },
    "partial_success": {
        "title": "–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–æ–±–µ–¥–∞",
        "description": """
        –•–æ—Ç—è –ø—Ä–µ—Å—Ç—É–ø–Ω–∏–∫ –Ω–µ –±—ã–ª –ø–æ–π–º–∞–Ω, –≤—ã —Å–æ–±—Ä–∞–ª–∏ –≤–∞–∂–Ω—ã–µ —É–ª–∏–∫–∏
        –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –¥–µ–ª–∞.
        
        {partial_results}
        
        –î–µ–ª–æ –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º, –Ω–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏ –≤–∞–∂–Ω—ã–π –≤–∫–ª–∞–¥.
        """,
        "rewards": {
            "experience": 50,
            "reputation": 25,
            "money": 500,
            "items": ["–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", EVIDENCE_DOCUMENTS],
        },
    },
    "failure": {
        "title": "–ù–µ—É–¥–∞—á–∞",
        "description": """
        –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, –∏ –¥–µ–ª–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Ä–∞—Å–∫—Ä—ã—Ç—ã–º.
        
        {failure_reasons}
        
        –ù–æ –∫–∞–∂–¥—ã–π –æ–ø—ã—Ç - —ç—Ç–æ —É—Ä–æ–∫ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.
        """,
        "rewards": {
            "experience": 25,
            "reputation": -10,
            "money": 100,
            "items": [EVIDENCE_DOCUMENTS],
        },
    },
}

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤
TEMPLATES = {
    Difficulty.EASY: [
        CASE_TEMPLATES["murder_basic"],  # –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω
        # –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥—Ä—É–≥–∏–µ —à–∞–±–ª–æ–Ω—ã
    ],
    Difficulty.MEDIUM: [
        CASE_TEMPLATES["murder_basic"],
        # –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥—Ä—É–≥–∏–µ —à–∞–±–ª–æ–Ω—ã
    ],
    Difficulty.HARD: [
        CASE_TEMPLATES["murder_basic"],
        # –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥—Ä—É–≥–∏–µ —à–∞–±–ª–æ–Ω—ã
    ],
    Difficulty.EXPERT: [
        CASE_TEMPLATES["murder_basic"],
        # –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥—Ä—É–≥–∏–µ —à–∞–±–ª–æ–Ω—ã
    ],
}


def get_template_by_difficulty(difficulty: int) -> Optional[CaseTemplate]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —É—Ä–æ–≤–Ω—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.

    Args:
        difficulty: –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (1-4)

    Returns:
        Optional[CaseTemplate]: –®–∞–±–ª–æ–Ω —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ None
    """
    try:
        diff_level = Difficulty(difficulty)
        available_templates = TEMPLATES.get(diff_level, [])
        if not available_templates:
            return None
        return random.choice(available_templates)
    except ValueError:
        return None


def customize_template(template: CaseTemplate, user_data: Dict) -> CaseTemplate:
    """
    –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–¥ –∏–≥—Ä–æ–∫–∞.

    Args:
        template: –ò—Å—Ö–æ–¥–Ω—ã–π —à–∞–±–ª–æ–Ω —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        user_data: –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ (—É—Ä–æ–≤–µ–Ω—å, –Ω–∞–≤—ã–∫–∏ –∏ —Ç.–¥.)

    Returns:
        CaseTemplate: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
    """
    # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —à–∞–±–ª–æ–Ω–∞
    customized = CaseTemplate(
        id=template.id,
        title=template.title,
        description=template.description,
        difficulty=template.difficulty,
        locations=template.locations.copy(),
        suspects=template.suspects.copy(),
        key_evidence=template.key_evidence.copy(),
        red_herrings=template.red_herrings.copy(),
        correct_sequence=template.correct_sequence.copy(),
        hints=template.hints.copy(),
    )

    # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–∫–∞
    detective_skill = user_data.get("detective_skill", 1)
    if detective_skill < 3:
        # –£–ø—Ä–æ—â–∞–µ–º –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö
        customized.key_evidence = customized.key_evidence[:3]
        customized.red_herrings = customized.red_herrings[:2]
        customized.correct_sequence = customized.correct_sequence[:5]
    elif detective_skill > 7:
        # –£—Å–ª–æ–∂–Ω—è–µ–º –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö
        customized.key_evidence.extend(customized.red_herrings[:2])
        customized.red_herrings.extend(customized.key_evidence[:2])
        random.shuffle(customized.key_evidence)
        random.shuffle(customized.red_herrings)

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–≤—ã–∫–æ–≤
    forensic_skill = user_data.get("forensic_skill", 1)
    if forensic_skill > 5:
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∞–Ω–∞–ª–∏–∑—É —É–ª–∏–∫
        customized.hints[1].extend(
            [
                "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤ –ø—è—Ç–µ–Ω",
                "–ò–∑—É—á–∏—Ç–µ –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–µ —Å–ª–µ–¥—ã",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–∞–ª—å—Ü–µ–≤",
            ]
        )

    psychology_skill = user_data.get("psychology_skill", 1)
    if psychology_skill > 5:
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É
        customized.hints[1].extend(
            [
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã—Ö",
                "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –Ω–µ–≤–µ—Ä–±–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã",
                "–ò–∑—É—á–∏—Ç–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏",
            ]
        )

    return customized
